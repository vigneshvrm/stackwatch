---
# STACKWATCH: Firewall Configuration Playbook
# Backend System Architect and Automation Engineer
#
# Purpose: Configure firewall with industry-standard rules
# Target: Ubuntu (localhost)
# Supports: firewalld, UFW, iptables
# Run: ansible-playbook -i ../inventory/hosts configure-firewall.yml --connection=local

- name: Configure StackWatch Firewall Rules
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    allowed_ports:
      - port: 80
        protocol: tcp
        service: http
        description: HTTP web traffic
      - port: 443
        protocol: tcp
        service: https
        description: HTTPS web traffic
    
    blocked_ports:
      - port: 9090
        description: Prometheus direct access (use /prometheus/ via Nginx)
      - port: 3000
        description: Grafana direct access (use /grafana/ via Nginx)
      - port: 9100
        description: Node Exporter direct access (internal only)
      - port: 9182
        description: Windows Exporter direct access (internal only)

  tasks:
    - name: Detect firewall system (Ubuntu-first)
      shell: |
        if command -v ufw &> /dev/null; then
          echo "ufw"
        elif command -v firewall-cmd &> /dev/null; then
          echo "firewalld"
        elif command -v iptables &> /dev/null; then
          echo "iptables"
        else
          echo "unknown"
        fi
      register: firewall_system
      changed_when: false

    - name: Set firewall system fact (trimmed)
      set_fact:
        firewall_type: "{{ firewall_system.stdout | trim }}"

    - name: Display detected firewall system
      debug:
        msg: "Detected firewall system: {{ firewall_type }}"

    # UFW Configuration (Ubuntu default)
    - name: Ensure UFW is installed (Ubuntu)
      apt:
        name: ufw
        state: present
      when: firewall_type == "ufw"
      ignore_errors: yes

    - name: Configure UFW - Allow HTTP
      ufw:
        rule: allow
        port: "80"
        proto: tcp
      when: firewall_type == "ufw"

    - name: Configure UFW - Allow HTTPS
      ufw:
        rule: allow
        port: "443"
        proto: tcp
      when: firewall_type == "ufw"

    - name: Configure UFW - Block Prometheus direct access
      ufw:
        rule: deny
        port: "9090"
        proto: tcp
      when: firewall_type == "ufw"

    - name: Configure UFW - Block Grafana direct access
      ufw:
        rule: deny
        port: "3000"
        proto: tcp
      when: firewall_type == "ufw"

    - name: Configure UFW - Block Node Exporter direct access
      ufw:
        rule: deny
        port: "9100"
        proto: tcp
      when: firewall_type == "ufw"

    - name: Configure UFW - Block Windows Exporter direct access
      ufw:
        rule: deny
        port: "9182"
        proto: tcp
      when: firewall_type == "ufw"

    - name: Check UFW status
      command: ufw status
      register: ufw_status_check
      changed_when: false
      failed_when: false
      when: firewall_type == "ufw"

    - name: Enable UFW (if not already enabled)
      ufw:
        state: enabled
      when: 
        - firewall_type == "ufw"
        - ufw_status_check.stdout is not defined or "Status: active" not in ufw_status_check.stdout
      register: ufw_enable_result

    - name: Verify UFW is enabled
      command: ufw status
      register: ufw_final_status
      changed_when: false
      when: firewall_type == "ufw"

    - name: Display UFW status
      debug:
        msg: "UFW status: {{ ufw_final_status.stdout_lines[0] if ufw_final_status.stdout_lines is defined else 'Unknown' }}"
      when: firewall_type == "ufw"

    # iptables Configuration (manual instructions)
    - name: Display iptables configuration instructions
      debug:
        msg:
          - "iptables detected. Manual configuration required."
          - "Recommended rules:"
          - "  iptables -A INPUT -p tcp --dport 80 -j ACCEPT"
          - "  iptables -A INPUT -p tcp --dport 443 -j ACCEPT"
          - "  iptables -A INPUT -p tcp --dport 9090 -j REJECT"
          - "  iptables -A INPUT -p tcp --dport 3000 -j REJECT"
          - "  iptables -A INPUT -p tcp --dport 9100 -j REJECT"
          - "  iptables -A INPUT -p tcp --dport 9182 -j REJECT"
      when: firewall_type == "iptables"

    - name: Verify firewall configuration
      debug:
        msg: "Firewall configuration completed for {{ firewall_type }}"
      when: firewall_type != "unknown"

    - name: Fail if firewall system is unknown
      fail:
        msg: "Unknown firewall system detected. Manual configuration required."
      when: firewall_type == "unknown"

