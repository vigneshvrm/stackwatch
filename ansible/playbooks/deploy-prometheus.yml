---
# STACKWATCH: Prometheus Deployment Playbook
# Backend System Architect and Automation Engineer
#
# Purpose: Deploy Prometheus container via Podman (Production-Grade)
# Target: Ubuntu (localhost)
# Run: ansible-playbook -i ../inventory/hosts deploy-prometheus.yml --connection=local
#
# IMPORTANT: All configuration values are read from config/stackwatch.json
# Do NOT hardcode values in this playbook

- name: Deploy StackWatch Prometheus
  hosts: localhost
  become: yes
  gather_facts: yes

  vars:
    # Path to Single Source of Truth configuration file
    stackwatch_config_path: "{{ playbook_dir }}/../../config/stackwatch.json"
    prometheus_container_name: "prometheus"

  tasks:
    - name: Load StackWatch configuration from JSON
      set_fact:
        stackwatch_config: "{{ lookup('file', stackwatch_config_path) | from_json }}"

    - name: Set Prometheus variables from config
      set_fact:
        prometheus_version: "{{ stackwatch_config.versions.prometheus }}"
        prometheus_image: "{{ stackwatch_config.images.prometheus }}:{{ stackwatch_config.versions.prometheus }}"
        prometheus_port: "{{ stackwatch_config.ports.prometheus }}"
        prometheus_memory: "{{ stackwatch_config.resources.prometheus.memory }}"
        prometheus_cpus: "{{ stackwatch_config.resources.prometheus.cpus }}"
        prometheus_config_dir: "{{ stackwatch_config.paths.prometheus_config }}"
        prometheus_data_dir: "{{ stackwatch_config.paths.prometheus_data }}"
        prometheus_retention_days: "{{ stackwatch_config.retention.prometheus_data_days }}"
        prometheus_storage_limit: "{{ stackwatch_config.retention.prometheus_storage_limit }}"

    - name: Display configuration being used
      debug:
        msg:
          - "Prometheus Version: {{ prometheus_version }}"
          - "Memory Limit: {{ prometheus_memory }}"
          - "CPU Limit: {{ prometheus_cpus }}"
          - "Data Retention: {{ prometheus_retention_days }} days"
          - "Storage Limit: {{ prometheus_storage_limit }}"

    - name: Check if Podman is installed
      command: which podman
      register: podman_check
      changed_when: false
      failed_when: false

    - name: Fail if Podman is not installed
      fail:
        msg: "Podman is not installed. Packages should be installed via deploy-from-opt.sh script."
      when: podman_check.rc != 0

    - name: Create Prometheus configuration directory
      file:
        path: "{{ prometheus_config_dir }}"
        state: directory
        mode: '0755'

    - name: Create Prometheus data directory
      file:
        path: "{{ prometheus_data_dir }}"
        state: directory
        mode: '0755'

    - name: Check if Prometheus config file exists
      stat:
        path: "{{ prometheus_config_dir }}/prometheus.yml"
      register: prometheus_config_stat

    - name: Backup existing Prometheus configuration
      copy:
        src: "{{ prometheus_config_dir }}/prometheus.yml"
        dest: "{{ prometheus_config_dir }}/prometheus.yml.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
      when: prometheus_config_stat.stat.exists
      ignore_errors: yes

    - name: Create Prometheus configuration file
      copy:
        dest: "{{ prometheus_config_dir }}/prometheus.yml"
        content: |
          # STACKWATCH: Prometheus Configuration
          # Backend System Architect and Automation Engineer
          # Version: {{ prometheus_version }}

          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          # Alertmanager configuration (if needed)
          # alerting:
          #   alertmanagers:
          #     - static_configs:
          #         - targets: []

          # Load rules (if needed)
          # rule_files:
          #   - "alerts/*.yml"

          scrape_configs:
            # Prometheus self-monitoring
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            # Node Exporter (Linux) - targets added via Ansible
            - job_name: 'node-exporter'
              static_configs:
                - targets: []
                  # Example: ['server1:9100', 'server2:9100']
                  # Configure via Ansible or manually

            # Windows Exporter - targets added manually or via service discovery
            - job_name: 'windows-exporter'
              static_configs:
                - targets: []
                  # Example: ['win-server1:9182', 'win-server2:9182']
        mode: '0644'

    - name: Check if Prometheus container exists
      shell: "{% raw %}podman ps -a --format '{{.Names}}'{% endraw %}"
      register: existing_containers
      changed_when: false
      failed_when: false

    - name: Stop existing Prometheus container
      command: podman stop {{ prometheus_container_name }}
      when: prometheus_container_name in existing_containers.stdout
      ignore_errors: yes

    - name: Remove existing Prometheus container
      command: podman rm {{ prometheus_container_name }}
      when: prometheus_container_name in existing_containers.stdout
      ignore_errors: yes

    - name: Pull Prometheus image
      command: podman pull {{ prometheus_image }}
      register: pull_result
      changed_when: "'Pulling' in pull_result.stdout or 'Downloading' in pull_result.stdout"

    - name: Start Prometheus container (Production-Grade)
      command: >
        podman run -d
        --name {{ prometheus_container_name }}
        --memory={{ prometheus_memory }}
        --cpus={{ prometheus_cpus }}
        --health-cmd='wget -q --spider http://localhost:9090/-/healthy || exit 1'
        --health-interval=30s
        --health-retries=3
        -v /etc/hosts:/etc/hosts:Z
        -v {{ prometheus_config_dir }}:/etc/prometheus:Z
        -v {{ prometheus_data_dir }}:/prometheus:Z
        -p {{ prometheus_port }}:9090
        {{ prometheus_image }}
        --config.file=/etc/prometheus/prometheus.yml
        --web.external-url=/prometheus/
        --web.route-prefix=/
        --storage.tsdb.retention.time={{ prometheus_retention_days }}d
        --storage.tsdb.retention.size={{ prometheus_storage_limit }}
        --storage.tsdb.path=/prometheus
        --web.enable-lifecycle
      register: container_start

    - name: Wait for Prometheus to start
      wait_for:
        port: "{{ prometheus_port }}"
        host: localhost
        delay: 3
        timeout: 30

    - name: Generate systemd service for Prometheus
      command: podman generate systemd --name {{ prometheus_container_name }} --new
      register: systemd_service
      changed_when: false

    - name: Create systemd service file
      copy:
        dest: "/etc/systemd/system/container-{{ prometheus_container_name }}.service"
        content: "{{ systemd_service.stdout }}"
        mode: '0644'
      when: systemd_service.rc == 0
      ignore_errors: yes

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes
      when: systemd_service.rc == 0
      ignore_errors: yes

    - name: Enable Prometheus systemd service
      systemd:
        name: "container-{{ prometheus_container_name }}.service"
        enabled: yes
      when: systemd_service.rc == 0
      ignore_errors: yes

    - name: Verify Prometheus container is running
      shell: "{% raw %}podman ps --format '{{.Names}}'{% endraw %}"
      register: running_containers
      changed_when: false

    - name: Check Prometheus health endpoint
      uri:
        url: "http://localhost:{{ prometheus_port }}/-/healthy"
        method: GET
        status_code: [200]
      register: health_check
      ignore_errors: yes

    - name: Display deployment status
      debug:
        msg:
          - "=========================================="
          - "Prometheus Production Deployment Complete"
          - "=========================================="
          - "Container: {{ prometheus_container_name }}"
          - "Version: {{ prometheus_version }}"
          - "Running: {{ prometheus_container_name in running_containers.stdout }}"
          - "Health: {{ 'OK' if health_check.status == 200 else 'Failed' }}"
          - ""
          - "Production Settings:"
          - "  Memory: {{ prometheus_memory }}"
          - "  CPUs: {{ prometheus_cpus }}"
          - "  Retention: {{ prometheus_retention_days }} days"
          - "  Storage Limit: {{ prometheus_storage_limit }}"
          - ""
          - "Access:"
          - "  Direct: http://localhost:{{ prometheus_port }}"
          - "  Via Nginx: http://$(hostname -I | awk '{print $1}')/prometheus"
