# Grafana ERR_TOO_MANY_REDIRECTS - Detailed Issue Analysis

**Date:** 2025-11-29  
**Status:** UNRESOLVED  
**Severity:** CRITICAL  
**Component:** Grafana + Nginx Reverse Proxy

---

## 1. Problem Description

### Symptom
When accessing Grafana via Nginx reverse proxy at `http://123.176.58.198/grafana/`, the browser shows:
- **Error:** `ERR_TOO_MANY_REDIRECTS`
- **HTTP Response:** `301 Moved Permanently` redirecting to the same URL
- **Location Header:** `http://123.176.58.198/grafana/` (redirects to itself)

### Test Command and Output
```bash
$ curl -I http://123.176.58.198/grafana/

HTTP/1.1 301 Moved Permanently
Server: nginx/1.18.0 (Ubuntu)
Date: Sat, 29 Nov 2025 16:55:22 GMT
Content-Type: text/html; charset=utf-8
Connection: keep-alive
Cache-Control: no-store
Location: http://123.176.58.198/grafana/
X-Content-Type-Options: nosniff
X-Frame-Options: deny
X-Xss-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
```

**Key Observation:** The `Location` header points to the exact same URL, creating an infinite redirect loop.

---

## 2. Current Configuration

### 2.1 Grafana Configuration (`/etc/grafana/config/grafana.ini`)

**Generated by:** `scripts/deploy-grafana.sh`  
**Domain Detection:** Uses `GRAFANA_DOMAIN` environment variable or auto-detects IP

```ini
[server]
http_port = 3000
domain = 123.176.58.198
root_url = %(protocol)s://%(domain)s/grafana/
serve_from_sub_path = true
enforce_domain = false

[database]
type = sqlite3
path = /var/lib/grafana/data/grafana.db

[security]
admin_user = admin
cookie_samesite = lax
admin_password = admin
secret_key = CHANGE_THIS_SECRET_KEY_IN_PRODUCTION

[users]
allow_sign_up = false

[log]
mode = console
level = info
```

**Key Settings:**
- `root_url = %(protocol)s://%(domain)s/grafana/` (with trailing slash)
- `serve_from_sub_path = true`
- `enforce_domain = false`
- `cookie_samesite = lax`

### 2.2 Nginx Configuration (`/etc/nginx/sites-available/stackwatch`)

**Generated by:** `scripts/deploy-nginx.sh`

```nginx
server {
    listen 80;
    server_name _;
    root /var/www/stackwatch/dist;
    index index.html;

    # Serve StackWatch Frontend (SPA routing support)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Route to Prometheus (backend service)
    location /prometheus/ {
        proxy_pass http://localhost:9090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_redirect http://localhost:9090/ /prometheus/;
        proxy_redirect http://$host:9090/ /prometheus/;
        proxy_redirect default;
    }
    
    location /prometheus {
        return 301 /prometheus/;
    }

    # Route to Grafana (backend service)
    # CRITICAL: Use proxy_redirect off to let Grafana handle redirects based on root_url
    # When serve_from_sub_path=true, Grafana generates correct redirects - don't modify them
    location /grafana/ {
        proxy_pass http://localhost:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # CRITICAL: Turn off proxy_redirect - let Grafana handle redirects via root_url
        # Grafana with serve_from_sub_path=true generates correct redirects automatically
        proxy_redirect off;
    }
    
    # Handle Grafana without trailing slash
    location /grafana {
        return 301 /grafana/;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

**Key Settings:**
- `proxy_pass http://localhost:3000/;` (trailing slash strips `/grafana/` prefix)
- `proxy_redirect off;` (lets Grafana handle redirects)
- Proper headers set: `Host`, `X-Forwarded-*`, etc.

### 2.3 Grafana Container Configuration

**Container:** `grafana` (Podman container)  
**Image:** `docker.io/grafana/grafana:latest`  
**Port:** `3000` (internal, not exposed externally)  
**Volumes:**
- `/etc/grafana/config/grafana.ini:/etc/grafana/grafana.ini:Z`
- `/var/lib/grafana:/var/lib/grafana:Z`
- `/etc/grafana/provisioning/*:/etc/grafana/provisioning/*:Z`

**Service:** `container-grafana.service` (systemd)

---

## 3. What We've Tried (Chronological Attempts)

### Attempt 1: Initial Configuration
- **Grafana:** `root_url` with trailing slash, `serve_from_sub_path = true`
- **Nginx:** `proxy_pass` with trailing slash, multiple `proxy_redirect` rules
- **Result:** ❌ Redirect loop

### Attempt 2: Removed Trailing Slash from root_url
- **Grafana:** `root_url = %(protocol)s://%(domain)s/grafana` (no trailing slash)
- **Nginx:** Kept `proxy_redirect` rules
- **Result:** ❌ Redirect loop persisted

### Attempt 3: Added Domain Detection
- **Grafana:** Auto-detect IP, set `domain` explicitly
- **Nginx:** Enhanced `proxy_redirect` rules with catch-all
- **Result:** ❌ Redirect loop persisted

### Attempt 4: Simplified Redirect Rules
- **Grafana:** `root_url` without trailing slash, `enforce_domain = false`
- **Nginx:** Simplified `proxy_redirect` rules
- **Result:** ❌ Redirect loop persisted

### Attempt 5: Used Rewrite Rules
- **Grafana:** `root_url` with trailing slash
- **Nginx:** Added `rewrite ^/grafana/(.*) /$1 break;` before `proxy_pass`
- **Result:** ❌ Redirect loop persisted

### Attempt 6: proxy_redirect off (Current)
- **Grafana:** `root_url = %(protocol)s://%(domain)s/grafana/` (with trailing slash)
- **Nginx:** `proxy_redirect off;` (let Grafana handle redirects)
- **Result:** ❌ Redirect loop persists

---

## 4. Environment Details

### Server Information
- **OS:** Ubuntu (version from nginx header: nginx/1.18.0)
- **Public IP:** `123.176.58.198`
- **Private IP:** `10.1.1.217` (detected by script)
- **Network:** Behind NAT (public IP not on interface)

### Deployment Method
- **Grafana:** Podman container
- **Nginx:** System package (not containerized)
- **Deployment Scripts:** Bash scripts in `scripts/` directory

### Access Pattern
- **External Access:** `http://123.176.58.198/grafana/`
- **Internal Access:** `http://localhost:3000/` (direct to Grafana, works)
- **Nginx Proxy:** `http://localhost/grafana/` (via Nginx, redirects loop)

---

## 5. Detailed Analysis

### 5.1 Request Flow (Current)

1. **User Request:** `GET http://123.176.58.198/grafana/`
2. **Nginx Receives:** Matches `location /grafana/`
3. **Nginx Proxies:** `proxy_pass http://localhost:3000/` → strips `/grafana/` prefix
4. **Grafana Receives:** Request at `/` (root path)
5. **Grafana Checks:** `root_url = http://123.176.58.198/grafana/`
6. **Grafana Redirects:** `Location: http://123.176.58.198/grafana/` (same URL!)
7. **Loop:** Step 1 repeats infinitely

### 5.2 Why Grafana Redirects to Same URL

**Hypothesis:** Grafana sees the request at `/` but knows from `root_url` it should be at `/grafana/`. However, when it generates the redirect, it's redirecting to `/grafana/` which is the same URL that triggered the request.

**Possible Causes:**
1. Grafana's `root_url` parsing might be incorrect
2. The `domain` variable might not be expanding correctly
3. Grafana might be checking the request path incorrectly
4. There might be a cookie/session issue causing redirects

### 5.3 Key Observations

1. **Direct Access Works:** `curl http://localhost:3000/` works (Grafana accessible directly)
2. **Nginx Proxy Fails:** `curl http://localhost/grafana/` creates redirect loop
3. **Same Location Header:** Grafana redirects to the exact same URL
4. **Prometheus Works:** Similar setup with `/prometheus/` works fine

---

## 6. Step-by-Step Troubleshooting Guide

### Step 1: Verify Grafana Configuration

```bash
# Check actual Grafana config file
sudo cat /etc/grafana/config/grafana.ini | grep -A 5 "\[server\]"

# Expected output:
# [server]
# http_port = 3000
# domain = 123.176.58.198
# root_url = %(protocol)s://%(domain)s/grafana/
# serve_from_sub_path = true
# enforce_domain = false
```

**Verify:**
- `domain` is set to the public IP (not empty, not localhost)
- `root_url` has trailing slash and matches `/grafana/`
- `serve_from_sub_path = true`

### Step 2: Check Grafana Container Logs

```bash
# View recent Grafana logs
sudo podman logs grafana --tail 50

# Look for:
# - Redirect-related messages
# - Configuration loading errors
# - Path resolution issues
```

**What to look for:**
- Errors about `root_url` parsing
- Warnings about domain mismatch
- Redirect generation logs

### Step 3: Test Direct Grafana Access

```bash
# Test Grafana directly (bypass Nginx)
curl -I http://localhost:3000/

# Expected: Should redirect to login or show 200 OK
# If this also redirects, the issue is in Grafana config, not Nginx
```

### Step 4: Test Nginx Proxy with Verbose Logging

```bash
# Enable debug logging in Nginx (temporarily)
sudo nano /etc/nginx/nginx.conf
# Add: error_log /var/log/nginx/error.log debug;

# Reload Nginx
sudo nginx -t
sudo systemctl reload nginx

# Test and check logs
curl -v http://localhost/grafana/ 2>&1 | tee /tmp/curl-output.txt
sudo tail -f /var/log/nginx/error.log
```

### Step 5: Check Grafana's Actual Redirect Response

```bash
# Get full response including redirect
curl -L -v http://123.176.58.198/grafana/ 2>&1 | head -50

# Check what Location header Grafana is actually sending
curl -I http://localhost:3000/ 2>&1 | grep -i location
```

### Step 6: Verify Domain Variable Expansion

```bash
# Check if Grafana is expanding %(domain)s correctly
# Access Grafana directly and check what URLs it generates
curl http://localhost:3000/api/health
curl http://localhost:3000/api/frontend/settings
```

### Step 7: Test with Minimal Configuration

**Temporary Test - Remove subpath:**

```bash
# Edit Grafana config temporarily
sudo nano /etc/grafana/config/grafana.ini
# Change: serve_from_sub_path = false
# Change: root_url = %(protocol)s://%(domain)s/

# Restart Grafana
sudo podman restart grafana

# Test direct access
curl -I http://localhost:3000/
```

**If this works, the issue is specifically with subpath handling.**

### Step 8: Check for Cookie/Session Issues

```bash
# Test with fresh session (no cookies)
curl -I -c /dev/null http://123.176.58.198/grafana/

# Check if Grafana is setting cookies that cause redirects
curl -v http://localhost:3000/ 2>&1 | grep -i "set-cookie"
```

### Step 9: Compare with Working Prometheus Setup

```bash
# Prometheus works with similar setup - compare
curl -I http://123.176.58.198/prometheus/

# Check Prometheus Nginx config
grep -A 10 "location /prometheus" /etc/nginx/sites-available/stackwatch
```

**Key Difference:** Prometheus uses `proxy_redirect` rules, Grafana uses `proxy_redirect off`

### Step 10: Test Alternative Nginx Configuration

**Option A: Use rewrite instead of proxy_pass trailing slash**

```nginx
location /grafana/ {
    rewrite ^/grafana/(.*) /$1 break;
    proxy_pass http://localhost:3000;
    # ... rest of config
}
```

**Option B: Use proxy_pass without trailing slash**

```nginx
location /grafana/ {
    proxy_pass http://localhost:3000;
    # ... rest of config
}
```

**Option C: Add explicit path handling**

```nginx
location /grafana {
    proxy_pass http://localhost:3000;
    proxy_set_header X-Forwarded-Prefix /grafana;
    # ... rest of config
}
```

---

## 7. Potential Root Causes

### 7.1 Grafana Configuration Issues

1. **Domain Variable Not Expanding:**
   - `%(domain)s` might not be expanding to `123.176.58.198`
   - Check if Grafana is using `localhost` or empty domain

2. **root_url Format Issue:**
   - Trailing slash might be causing path matching issues
   - Protocol variable `%(protocol)s` might not be resolving correctly

3. **serve_from_sub_path Logic:**
   - Grafana might not be correctly handling the subpath
   - Could be a version-specific bug

### 7.2 Nginx Configuration Issues

1. **Path Stripping:**
   - `proxy_pass http://localhost:3000/` strips `/grafana/` but Grafana might expect it
   - Need to verify what path Grafana actually receives

2. **Header Issues:**
   - Missing or incorrect headers might confuse Grafana
   - `X-Forwarded-*` headers might not be set correctly

3. **proxy_redirect off:**
   - While recommended, might not work if Grafana generates incorrect redirects
   - Might need selective redirect rewriting

### 7.3 Container/Network Issues

1. **Host Header:**
   - Grafana might be seeing `localhost` instead of `123.176.58.198`
   - Container networking might be affecting header forwarding

2. **DNS Resolution:**
   - Grafana container might not resolve the domain correctly
   - DNS servers in container might be different

---

## 8. Recommended Next Steps

### Immediate Actions

1. **Check Grafana Logs:**
   ```bash
   sudo podman logs grafana --tail 100 | grep -i "redirect\|error\|warn"
   ```

2. **Verify Actual Config:**
   ```bash
   sudo podman exec grafana cat /etc/grafana/grafana.ini | grep -A 5 "\[server\]"
   ```

3. **Test Direct Access:**
   ```bash
   curl -v http://localhost:3000/ 2>&1 | head -30
   ```

4. **Check What Grafana Sees:**
   ```bash
   # Enable access logging in Grafana
   # Check what requests Grafana receives
   ```

### Investigation Paths

1. **Grafana Version:**
   - Check Grafana version: `sudo podman exec grafana grafana-server -v`
   - Research known issues with that version and subpath

2. **Alternative Configuration:**
   - Try serving Grafana from root path (no subpath) to isolate issue
   - Test with different `root_url` formats

3. **Community Resources:**
   - Check Grafana community forums for similar issues
   - Review Grafana GitHub issues for subpath redirect problems

4. **Minimal Test Case:**
   - Create minimal Nginx + Grafana setup to isolate the problem
   - Test with different Grafana versions

---

## 9. Files and Scripts Reference

### Relevant Files

- **Grafana Config:** `/etc/grafana/config/grafana.ini`
- **Nginx Config:** `/etc/nginx/sites-available/stackwatch`
- **Deploy Script:** `scripts/deploy-grafana.sh`
- **Nginx Script:** `scripts/deploy-nginx.sh`

### Key Script Functions

**Grafana Deployment (`scripts/deploy-grafana.sh`):**
- `create_grafana_config()` - Generates `grafana.ini`
- IP detection logic (lines 102-170)
- Config file creation (lines 172-200)

**Nginx Deployment (`scripts/deploy-nginx.sh`):**
- `create_nginx_config()` - Generates Nginx config
- Grafana location block (lines 96-115)

---

## 10. Additional Context

### Working Components

- **Prometheus:** Works correctly with `/prometheus/` subpath
- **Nginx:** Serves frontend correctly
- **Grafana Direct:** Works when accessed directly on port 3000

### Non-Working Component

- **Grafana via Nginx:** Redirect loop when accessed via `/grafana/` subpath

### Environment Constraints

- **NAT Environment:** Public IP not on server interface
- **Domain:** Using IP address, not domain name
- **Container:** Grafana in Podman container
- **Nginx:** System package, not containerized

---

## 11. Questions for Further Investigation

1. What exact path does Grafana receive when Nginx proxies the request?
2. What Location header is Grafana actually generating?
3. Is the `domain` variable expanding correctly in Grafana?
4. Are there any Grafana logs showing redirect decisions?
5. Does the issue occur with a fresh Grafana installation (no existing data)?
6. What happens if we serve Grafana from root path (no subpath)?
7. Is this a Grafana version-specific issue?
8. Are there any cookies or sessions causing redirects?

---

## 12. Summary

**Problem:** Grafana redirects to the same URL (`/grafana/`) creating an infinite loop when accessed via Nginx reverse proxy.

**Current State:** 
- Configuration follows Grafana official recommendations
- `proxy_redirect off` is set (as recommended)
- `root_url` includes trailing slash (as recommended)
- `serve_from_sub_path = true` (as recommended)
- Issue persists despite all standard fixes

**Next Steps:**
1. Deep dive into Grafana logs
2. Test with minimal configuration
3. Verify what Grafana actually receives/sees
4. Consider Grafana version-specific issues
5. Test alternative Nginx configurations

---

**Document Version:** 1.0  
**Last Updated:** 2025-11-29  
**Status:** ✅ RESOLVED

---

## 13. SOLUTION FOUND

### Working Configuration

**Root Cause:** 
- Grafana's `root_url` must be hardcoded (no variable substitution) with NO trailing slash
- Nginx `proxy_pass` must use `127.0.0.1` (not `localhost`) with NO trailing slash
- Explicit `protocol = http` must be set in Grafana config

### Final Working Configuration

**Grafana (`/etc/grafana/config/grafana.ini`):**
```ini
[server]
http_port = 3000
domain = 123.176.58.198
protocol = http
serve_from_sub_path = true
root_url = http://123.176.58.198/grafana    # Hardcoded, NO trailing slash
enforce_domain = false
```

**Nginx (`/etc/nginx/sites-available/stackwatch`):**
```nginx
location /grafana/ {
    proxy_pass http://127.0.0.1:3000;    # 127.0.0.1, NO trailing slash
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### Key Differences from Previous Attempts

1. **root_url:** Hardcoded `http://123.176.58.198/grafana` instead of `%(protocol)s://%(domain)s/grafana/`
2. **No trailing slash:** `root_url` ends without `/`
3. **protocol explicit:** Added `protocol = http` line
4. **proxy_pass:** Uses `127.0.0.1:3000` (no trailing slash) instead of `localhost:3000/`
5. **Simplified headers:** Removed `X-Forwarded-Host` and `X-Forwarded-Port`
6. **No proxy_redirect:** Removed `proxy_redirect off;` (uses default behavior)

### Scripts Updated

- `scripts/deploy-grafana.sh` - Now generates hardcoded `root_url` based on detected domain
- `scripts/deploy-nginx.sh` - Uses `127.0.0.1:3000` with simplified configuration

